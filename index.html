<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Happy Birthday ‚Äî A Little World For You</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Three.js (r150) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/examples/js/controls/OrbitControls.js"></script>

  <!-- GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.12.2/dist/gsap.min.js"></script>

  <!-- canvas-confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <!-- Fonts: Playfair Display & Satoshi (Fontshare) -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;900&display=swap" rel="stylesheet">
  <!-- Fontshare API for Satoshi -->
  <link rel="stylesheet" href="https://api.fontshare.com/v2/css?f[]=satoshi:400,600&display=swap">

  <style>
    :root{
      --bg:#0c0a09;
      --glass-bg: rgba(255,255,255,0.03);
      --glass-border: rgba(255,255,255,0.06);
      --muted:#cfcfd3;
      --accent-start:#ff5fa8;
      --accent-end:#ff2e50;
      --card-radius:18px;
    }

    html,body,#app{
      height:100%;
      margin:0;
      font-family: "Satoshi", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:var(--bg);
      color:var(--muted);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
    }

    /* Aurora layer (breathing radial gradients) */
    .aurora {
      position:fixed;
      inset:0;
      z-index:0;
      background: radial-gradient(400px at 10% 20%, hsla(333,70%,55%,.28), transparent 20%),
                  radial-gradient(420px at 80% 30%, hsla(282,82%,54%,.22), transparent 18%),
                  radial-gradient(520px at 60% 80%, hsla(210,89%,60%,.20), transparent 18%),
                  radial-gradient(620px at 30% 70%, hsla(35,90%,60%,.17), transparent 20%),
                  var(--bg);
      filter: blur(40px) saturate(1.05);
      animation: breathe 18s linear infinite;
      mix-blend-mode: screen;
      pointer-events:none;
    }
    @keyframes breathe{
      0%{ transform: translateY(0) scale(1) rotate(0deg); filter: blur(36px) saturate(1); opacity:1; }
      50%{ transform: translateY(-12px) scale(1.03) rotate(0.3deg); filter: blur(42px) saturate(1.1); opacity:0.95; }
      100%{ transform: translateY(0) scale(1) rotate(0deg); filter: blur(36px) saturate(1); opacity:1; }
    }

    /* Canvas Three.js container */
    #three-bg {
      position:fixed;
      inset:0;
      z-index:0;
      pointer-events:none;
    }

    /* Glass card styles */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      backdrop-filter: blur(10px) saturate(1.1);
      border: 1px solid var(--glass-border);
      border-radius: var(--card-radius);
      box-shadow: 0 10px 30px rgba(2,3,7,0.6);
      padding:28px;
      max-width:880px;
      margin:18px auto;
      color:var(--muted);
    }

    h1, h2 {
      font-family: "Playfair Display", serif;
      margin:0 0 8px 0;
      line-height:1.05;
      letter-spacing:-0.02em;
      font-weight:700;
      color:transparent;
      -webkit-background-clip:text;
      background-clip:text;
      background-image: linear-gradient(90deg, #ffb6d8 0%, #ffdce6 35%, #fff 70%);
      text-shadow: 0 4px 18px rgba(0,0,0,0.6);
    }

    p { margin:10px 0 18px 0; color: #dcdbe0; font-size:1rem; }

    /* Buttons */
    .btn {
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:12px 20px;
      cursor:pointer;
      border-radius:999px;
      border: none;
      font-weight:600;
      font-family:"Satoshi", system-ui, sans-serif;
      transform-origin:center;
      box-shadow: 0 6px 24px rgba(255,46,80,0.12);
      background: linear-gradient(90deg, var(--accent-start), var(--accent-end));
      color:white;
      transition: transform .18s ease, box-shadow .18s ease;
      user-select:none;
    }
    .btn:hover {
      transform: translateY(-6px) scale(1.05);
      box-shadow: 0 16px 40px rgba(255,46,80,0.22);
    }
    .btn:active {
      transform: translateY(-2px) scale(.99);
    }
    .btn[disabled]{
      opacity:.5;
      pointer-events:none;
      transform:none;
      box-shadow:none;
    }

    /* Progress bar at top-center */
    .progress-wrap {
      position:fixed;
      top:18px;
      left:50%;
      transform:translateX(-50%);
      width: min(720px, 90%);
      z-index:60;
      pointer-events:none;
      display:flex;
      justify-content:center;
    }
    .progress-track {
      width:100%;
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,0.04);
      border:1px solid rgba(255,255,255,0.03);
      padding:2px;
      backdrop-filter: blur(6px);
    }
    .progress-bar {
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg,var(--accent-start),var(--accent-end));
      box-shadow: 0 6px 18px rgba(255,46,80,0.12), inset 0 0 20px rgba(255,255,255,0.02);
      transition: width .7s cubic-bezier(.2,.9,.2,1);
    }

    /* Layout */
    .stage {
      position:relative;
      z-index:50;
      height:100%;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 32px;
      box-sizing:border-box;
      overflow:auto;
    }

    .step-container {
      width:100%;
      max-width:980px;
      margin:auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
      align-items:center;
    }

    .center {
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      text-align:center;
    }

    .icon-large {
      font-size:84px;
      filter: drop-shadow(0 8px 34px rgba(255,95,168,0.18));
      transform-origin:center;
      margin-bottom:6px;
    }
    .heart-beat{
      animation: beat 1.8s ease-in-out infinite;
    }
    @keyframes beat{
      0%{ transform:scale(1); opacity:0.95; filter: drop-shadow(0 4px 18px rgba(255,95,168,0.12)); }
      50%{ transform:scale(1.08); opacity:1; filter: drop-shadow(0 12px 36px rgba(255,95,168,0.22)); }
      100%{ transform:scale(1); opacity:0.95; }
    }

    /* Bento grid for step 3 */
    .bento {
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: 140px;
      gap:12px;
    }
    .bento-card{
      background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:14px;
      border:1px solid rgba(255,255,255,0.03);
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .bento-card.large { grid-column: span 2; grid-row: span 1; }
    .bento-title { font-weight:700; font-family: "Playfair Display", serif; margin-bottom:6px; color:transparent; background-clip:text; -webkit-background-clip:text; background-image: linear-gradient(90deg,#ffd5ea,#ffecf5); }
    .bento-text { font-size:.95rem; color:#e7e6ea; }

    /* Polaroid */
    .polaroid {
      width:320px;
      max-width:84vw;
      background:linear-gradient(180deg,#fff,#f7f7f7);
      padding:12px 12px 18px 12px;
      border-radius:12px;
      box-shadow: 0 18px 48px rgba(2,3,7,0.55);
      transform-style:preserve-3d;
      transition: transform .18s ease;
      cursor:grab;
      border: 1px solid rgba(0,0,0,0.06);
      perspective:1000px;
    }
    .polaroid img {
      width:100%;
      display:block;
      border-radius:8px;
    }
    .polaroid .caption {
      margin-top:10px;
      font-weight:600;
      color:#333;
      text-align:left;
      font-family:"Satoshi",sans-serif;
      font-size:.95rem;
    }

    /* Footer controls: mute */
    .controls {
      position:fixed;
      right:18px;
      bottom:18px;
      z-index:80;
      display:flex;
      gap:12px;
      align-items:center;
    }
    .mute-toggle {
      background: rgba(255,255,255,0.03);
      border:1px solid rgba(255,255,255,0.04);
      padding:10px;
      border-radius:12px;
      color:var(--muted);
      cursor:pointer;
      backdrop-filter: blur(6px);
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-weight:600;
    }

    /* Responsive tweaks */
    @media (max-width:900px){
      h1{ font-size:26px; }
      .icon-large { font-size:64px; }
      .bento { grid-template-columns: repeat(2, 1fr); grid-auto-rows:120px;}
      .bento-card.large { grid-column: span 2; }
    }
    @media (max-width:520px){
      .card { padding:18px; border-radius:14px; margin:12px; }
      .progress-wrap{ top:12px; }
      .polaroid { width:86vw; }
    }

  </style>
</head>
<body>
  <div class="aurora" aria-hidden="true"></div>
  <canvas id="three-bg"></canvas>

  <!-- Progress -->
  <div class="progress-wrap" aria-hidden="true">
    <div class="progress-track">
      <div class="progress-bar" id="progressBar" style="width:0%"></div>
    </div>
  </div>

  <div id="app" class="stage">
    <!-- Steps stack -->
    <div id="steps" class="step-container w-full">

      <!-- Step 1 -->
      <div class="card center step" data-step="1" style="opacity:1;">
        <div class="icon-large heart-beat" id="welcomeIcon">‚ù§Ô∏è</div>
        <h1>Hey Beautiful,</h1>
        <p>I built a little world for you, just to bring a smile to your face on your special day.</p>
        <div style="display:flex;gap:12px;justify-content:center">
          <button class="btn" data-next>Let's Begin</button>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="card center step hidden" data-step="2" style="opacity:0;">
        <div class="icon-large" id="partyIcon">üéâ</div>
        <h1>Happy Birthday!</h1>
        <p>Another year of you making the world brighter. Your existence is a gift, and I'm so lucky to witness it.</p>
        <div style="display:flex;gap:12px;justify-content:center">
          <button class="btn" data-next>There's more...</button>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="card step hidden" data-step="3" style="opacity:0;">
        <h2>A Few Things I Adore About You</h2>
        <div class="bento" style="margin-top:12px;">
          <div class="bento-card large">
            <div class="bento-title">‚ú® Your Unmatched Kindness</div>
            <div class="bento-text">The genuine warmth you show to everyone is something truly rare and beautiful.</div>
          </div>
          <div class="bento-card">
            <div class="bento-title">üòä That Smile</div>
            <div class="bento-text">It's a work of art.</div>
          </div>
          <div class="bento-card large">
            <div class="bento-title">üåü Your Radiant Spirit</div>
            <div class="bento-text">Your passion for life is infectious. Being around you makes everything feel more exciting and possible.</div>
          </div>
        </div>
        <div style="display:flex;gap:12px;justify-content:center;margin-top:16px">
          <button class="btn" data-next>Remember this?</button>
        </div>
      </div>

      <!-- Step 4 -->
      <div class="card center step hidden" data-step="4" style="opacity:0;">
        <h2>That One Time...</h2>
        <div style="margin:18px 0;">
          <div class="polaroid" id="polaroid">
            <img src="https://i.ibb.co/6Z6XgCg/crush.webp" alt="Our memory">
            <div class="caption">Our favorite memory.</div>
          </div>
        </div>
        <p>Every moment with you feels like a scene from a movie I'd watch on repeat.</p>
        <div style="display:flex;gap:12px;justify-content:center">
          <button class="btn" data-next>One last thing...</button>
        </div>
      </div>

      <!-- Step 5 -->
      <div class="card center step hidden" data-step="5" style="opacity:0;">
        <div class="icon-large" id="cakeIcon">üéÇ</div>
        <h1>My Wish For You</h1>
        <p>May the next year bring you all the love, success, and pure happiness you so rightfully deserve. May your dreams soar higher than ever.</p>
        <div id="finalMessage" style="margin-top:12px;min-height:48px;"></div>
        <div style="display:flex;gap:12px;justify-content:center;margin-top:8px">
          <button class="btn" id="celebrateBtn">Celebrate!</button>
        </div>
      </div>

    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="mute-toggle" id="muteToggle" aria-pressed="false">üîä Sound ON</div>
  </div>

  <script>
    /*****************************************
     * Basic state + utility
     *****************************************/
    const steps = Array.from(document.querySelectorAll('.step'));
    let current = 0; // 0-based index
    const total = steps.length;
    const progressBar = document.getElementById('progressBar');

    function setProgress(i) {
      const pct = Math.round(((i)/ (total - 1)) * 100);
      progressBar.style.width = pct + '%';
    }
    setProgress(0);

    // Simple show/hide with GSAP
    function gotoStep(index) {
      if (index < 0 || index >= steps.length) return;
      const prev = steps[current];
      const next = steps[index];
      if (prev === next) return;
      // animate out prev
      gsap.timeline()
        .to(prev, {duration:.45, opacity:0, scale:.96, y:20, ease:"power2.inOut", onComplete: ()=> prev.classList.add('hidden')})
        .fromTo(next, {opacity:0, scale:1.03, y:24}, {duration:.7, opacity:1, scale:1, y:0, ease:"power3.out", onStart: ()=> {
          next.classList.remove('hidden');
        }});
      current = index;
      setProgress(current);
    }

    // Next buttons
    document.querySelectorAll('[data-next]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        playClick();
        gotoStep(Math.min(current+1, total-1));
      });
    });

    // Polaroid cursor parallax
    const polaroid = document.getElementById('polaroid');
    polaroid?.addEventListener('mousemove', (e)=>{
      const r = polaroid.getBoundingClientRect();
      const cx = r.left + r.width/2;
      const cy = r.top + r.height/2;
      const dx = (e.clientX - cx) / r.width;
      const dy = (e.clientY - cy) / r.height;
      polaroid.style.transform = `rotateY(${dx*8}deg) rotateX(${ -dy*6 }deg) translateZ(6px)`;
    });
    polaroid?.addEventListener('mouseleave', ()=> polaroid.style.transform='rotateY(0) rotateX(0)');

    /*****************************************
     * Sound system (WebAudio synthesized for copyright-free audio)
     *****************************************/
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let audioEnabled = true;
    const muteToggle = document.getElementById('muteToggle');
    muteToggle.addEventListener('click', ()=>{
      audioEnabled = !audioEnabled;
      muteToggle.textContent = audioEnabled ? 'üîä Sound ON' : 'üîà Muted';
      muteToggle.setAttribute('aria-pressed', String(!audioEnabled));
      if (!audioEnabled) audioCtx.suspend(); else audioCtx.resume();
    });

    // Click sound: short pitch envelope
    function playClick(){
      if (!audioEnabled) return;
      try {
        const now = audioCtx.currentTime;
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = 'sine';
        o.frequency.setValueAtTime(1200, now);
        o.frequency.exponentialRampToValueAtTime(800, now + 0.03);
        g.gain.setValueAtTime(0, now);
        g.gain.linearRampToValueAtTime(0.12, now + 0.006);
        g.gain.linearRampToValueAtTime(0.0001, now + 0.14);
        o.connect(g);
        g.connect(audioCtx.destination);
        o.start(now);
        o.stop(now + 0.16);
      } catch(e){/*ignore*/ }
    }

    // Soft ambient pad loop (two detuned saws, slow tremolo)
    const masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.05;
    masterGain.connect(audioCtx.destination);

    // create pad only when not muted and once user interacts for auto-play policies
    let padNodes = null;
    function startPad(){
      if (padNodes || !audioEnabled) return;
      const now = audioCtx.currentTime;
      // two oscillators detuned
      const o1 = audioCtx.createOscillator();
      const o2 = audioCtx.createOscillator();
      o1.type='sine'; o2.type='sine';
      o1.frequency.value = 220; // A3
      o2.frequency.value = 277.18; // C#4 detune
      const g1 = audioCtx.createGain(); g1.gain.value = 0.25;
      const g2 = audioCtx.createGain(); g2.gain.value = 0.18;

      // lowpass
      const lp = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value = 900;
      // slow tremolo
      const lfo = audioCtx.createOscillator(); lfo.type='sine'; lfo.frequency.value = 0.06;
      const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 0.6;

      o1.connect(g1); o2.connect(g2);
      g1.connect(lp); g2.connect(lp);
      lp.connect(masterGain);

      lfo.connect(lfoGain);
      lfoGain.connect(g1.gain);
      lfoGain.connect(g2.gain);

      // start
      o1.start(now); o2.start(now); lfo.start(now);
      // gentle fade-in
      masterGain.gain.setValueAtTime(0.0001, now);
      masterGain.gain.linearRampToValueAtTime(0.05, now + 2.0);

      padNodes = {o1,o2,lfo,g1,g2,lp};
    }

    function stopPad(){
      if (!padNodes) return;
      const now = audioCtx.currentTime;
      masterGain.gain.cancelScheduledValues(now);
      masterGain.gain.setValueAtTime(masterGain.gain.value, now);
      masterGain.gain.linearRampToValueAtTime(0.0001, now + 1.4);
      // stop oscillators after fade
      setTimeout(()=>{
        try { padNodes.o1.stop(); padNodes.o2.stop(); padNodes.lfo.stop(); } catch(e){}
        padNodes = null;
      },1600);
    }

    // Start pad on first user interaction (to comply with autoplay)
    document.addEventListener('click', function firstStart(){
      startPad();
      document.removeEventListener('click', firstStart);
    });

    /*****************************************
     * Three.js: floating hearts
     *****************************************/
    const canvas = document.getElementById('three-bg');
    const renderer = new THREE.WebGLRenderer({canvas:canvas, alpha:true, antialias:true});
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 5000);
    camera.position.set(0,0,120);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.outputEncoding = THREE.sRGBEncoding;

    // lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x220022, 0.65);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffd1e7, 0.85);
    dir.position.set(0.6, 1, 0.8);
    scene.add(dir);

    // heart shape function
    function createHeartShape(scale=1){
      const x = 0, y = 0;
      const heart = new THREE.Shape();
      heart.moveTo(x, y + 5*scale);
      heart.bezierCurveTo(x, y+5*scale, x-5*scale, y+2*scale, x-5*scale, y-2*scale);
      heart.bezierCurveTo(x-5*scale, y-7*scale, x, y-10*scale, x, y-14*scale);
      heart.bezierCurveTo(x, y-10*scale, x+5*scale, y-7*scale, x+5*scale, y-2*scale);
      heart.bezierCurveTo(x+5*scale, y+2*scale, x, y+5*scale, x, y+5*scale);
      return heart;
    }

    // create a set of hearts
    const heartGroup = new THREE.Group();
    scene.add(heartGroup);
    const heartCount = 22;
    const hearts = [];
    for(let i=0;i<heartCount;i++){
      const scale = THREE.MathUtils.randFloat(0.6, 2.6);
      const shape = createHeartShape(1.6 * scale);
      const extrudeSettings = { depth: 2 + Math.random()*6, bevelEnabled:true, bevelThickness:0.8, bevelSize:0.6, bevelSegments:2 };
      const geom = new THREE.ExtrudeGeometry(shape, extrudeSettings);
      geom.computeVertexNormals();
      const hue = THREE.MathUtils.randFloat(330,350);
      const mat = new THREE.MeshStandardMaterial({
        color: new THREE.Color(`hsl(${hue} 80% ${THREE.MathUtils.randFloat(45,60)}%)`),
        metalness: 0.18,
        roughness: 0.42,
        emissive: new THREE.Color(`hsl(${hue} 60% ${THREE.MathUtils.randFloat(3,8)}%)`),
        emissiveIntensity: 0.05,
        flatShading:false
      });
      const mesh = new THREE.Mesh(geom, mat);
      mesh.castShadow = false;
      mesh.receiveShadow = false;
      mesh.position.set(THREE.MathUtils.randFloatSpread(240), THREE.MathUtils.randFloatSpread(140), THREE.MathUtils.randFloat(-40, 60));
      mesh.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, Math.random()*Math.PI);
      mesh.scale.setScalar(THREE.MathUtils.randFloat(0.7, 1.8));
      heartGroup.add(mesh);
      hearts.push({
        mesh,
        baseY:mesh.position.y,
        offset: Math.random()*Math.PI*2,
        speed: THREE.MathUtils.randFloat(0.3,1.0),
        swirlAngle: Math.random()*Math.PI*2
      });
    }

    // resize handler
    window.addEventListener('resize', ()=>{
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // animate hearts
    let tStart = performance.now();
    let finalTriggered = false;
    function animate(){
      const t = (performance.now()-tStart)/1000;
      // subtle group drift and rotation
      heartGroup.rotation.y = Math.sin(t*0.05) * 0.04;
      heartGroup.position.x = Math.sin(t*0.12) * 6;
      // per-heart float
      hearts.forEach((h, idx)=>{
        const m = h.mesh;
        m.position.y = h.baseY + Math.sin(t*h.speed + h.offset) * (6 + idx%3);
        m.rotation.x += 0.002 * (0.5 + h.speed*0.4);
        m.rotation.y += 0.0015 * (0.8 + h.speed*0.6);
      });
      renderer.render(scene, camera);
      requestAnimationFrame(animate);
    }
    animate();

    /*****************************************
     * Finale: confetti + hearts swirl out
     *****************************************/
    const celebrateBtn = document.getElementById('celebrateBtn');
    const finalMessageNode = document.getElementById('finalMessage');

    celebrateBtn.addEventListener('click', async function(){
      playClick();
      // disable button
      celebrateBtn.setAttribute('disabled','');
      gsap.to(celebrateBtn, {duration:.5, opacity:0, scale:.96, ease:'power2.out'});

      // show final text
      await new Promise(r => setTimeout(r, 350));
      finalMessageNode.innerHTML = `<h2 style="font-family:Playfair Display, serif; margin:0; color:transparent; background-clip:text; -webkit-background-clip:text; background-image: linear-gradient(90deg,#ffd5ea,#ffecf5);">Happy Birthday, my crush! ‚ù§Ô∏è</h2>`;

      // animate text in
      gsap.fromTo(finalMessageNode, {y:24, opacity:0}, {y:0, opacity:1, duration:.9, ease:'power3.out'});

      // powerful corner bursts then gentle shower with emoji and hearts
      const duration = 5 * 1000;
      // explosions from bottom corners
      confetti({
        particleCount: 60,
        startVelocity: 40,
        spread:120,
        origin: { x: 0.03, y: 0.9 },
        ticks: 180,
      });
      confetti({
        particleCount: 60,
        startVelocity: 42,
        spread:120,
        origin: { x: 0.97, y: 0.9 },
        ticks: 180,
      });

      // continuous gentle multi-type shower
      const end = Date.now() + duration;
      (function frame(){
        confetti({
          particleCount: 18,
          startVelocity: 8,
          spread: 50,
          origin: { x: Math.random(), y: Math.random() * 0.6 },
          shapes: ['square','circle'],
          scalar: Math.random() * 0.6 + 0.6,
        });
        // emoji confetti: use tiny text-based particles by drawing images ‚Äî canvas-confetti supports images via particleFunction in advanced usage,
        // but to keep single-file simple we'll emit a few stars/hearts as text-shaped via the 'shape' param isn't supported; instead, we sprinkle more colorful pieces.
        if (Date.now() < end) {
          setTimeout(frame, 300 + Math.random()*220);
        }
      })();

      // Hearts final swirl: animate hearts to swirl out & float up then fade
      finalTriggered = true;
      hearts.forEach((h, i) => {
        const m = h.mesh;
        const delay = i * 0.04;
        const dir = (i%2===0)?1:-1;
        gsap.to(m.position, {
          duration: 3.2,
          delay,
          x: m.position.x + dir * THREE.MathUtils.randFloat(60,140),
          y: m.position.y + THREE.MathUtils.randFloat(120, 240),
          z: m.position.z + THREE.MathUtils.randFloat(40, 180),
          ease: "power2.inOut"
        });
        gsap.to(m.rotation, {duration:3.4, delay, x: m.rotation.x + Math.PI*dir, y: m.rotation.y + Math.PI*dir, ease:'power2.inOut'});
        // fade material by reducing emissive and roughness (simulate fade)
        gsap.to(m.material, {duration:3.2, delay, opacity:0, onUpdate:function(){
          m.material.transparent = true;
        }});
        // eventually remove mesh to keep renderer light
        setTimeout(()=>{ try{ heartGroup.remove(m); }catch(e){} }, 4200 + delay*1000);
      });

      // gentle celebratory melody (tiny arpeggio)
      if (audioEnabled){
        playClick();
        const now = audioCtx.currentTime;
        const notes = [392, 523.25, 659.25, 783.99]; // G4, C5, E5, G5
        let idx = 0;
        const gMaster = audioCtx.createGain(); gMaster.gain.value = 0.08; gMaster.connect(audioCtx.destination);
        function playNote(){
          if (idx >= notes.length) return;
          const o = audioCtx.createOscillator();
          const gain = audioCtx.createGain();
          o.type='triangle';
          o.frequency.value = notes[idx];
          gain.gain.setValueAtTime(0.0001, now + idx*0.18);
          gain.gain.linearRampToValueAtTime(0.1, now + idx*0.18 + 0.02);
          gain.gain.exponentialRampToValueAtTime(0.0001, now + idx*0.18 + 0.9);
          o.connect(gain); gain.connect(gMaster);
          o.start(now + idx*0.18);
          o.stop(now + idx*0.18 + 1.1);
          idx++;
          if (idx < notes.length) setTimeout(playNote, 180);
        }
        playNote();
      }
    });

    /*****************************************
     * Accessibility: keyboard navigation for steps (Left/Right)
     *****************************************/
    window.addEventListener('keydown', (e)=>{
      if (e.key === 'ArrowRight' || e.key === 'Enter') {
        playClick();
        gotoStep(Math.min(current+1, total-1));
      } else if (e.key === 'ArrowLeft') {
        playClick();
        gotoStep(Math.max(current-1, 0));
      }
    });

    /*****************************************
     * Extra polish: subtle entrance animation on load
     *****************************************/
    window.addEventListener('load', ()=>{
      steps.forEach((s, i) => {
        if (i === 0) {
          gsap.fromTo(s, {opacity:0, y:18, scale:1.02}, {opacity:1, y:0, scale:1, duration:1.1, ease:'expo.out', delay:0.2});
        } else {
          s.classList.add('hidden');
        }
      });
      // Slightly nudge the aurora for dramatic effect
      gsap.to('.aurora', {duration:4, scale:1.01, y:-6, repeat:-1, yoyo:true, ease:'sine.inOut'});
    });

    // Make sure audio context resumes on user gesture (some browsers block otherwise)
    document.addEventListener('pointerdown', async () => {
      if (audioCtx.state === 'suspended') try{ await audioCtx.resume(); } catch(e){}
    }, {once:true});

  </script>
</body>
</html>
